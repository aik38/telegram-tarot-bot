# WBS - Telegram Tarot Bot（MVP → β → 初期グロース）

> 目的：**バックエンドを仕上げつつ、Telegram上の「ユーザー体験（フロント）」を磨き、キャラクターとマーケを“計測できる形”で回す**  
> 方針：最小で回る形を作る → 計測 → 改善（作り込みすぎない）

---

## 記号ルール（おすすめ）
- `[ ]` 未着手 / ToDo
- `[~]` 進行中
- `[x]` 完了
- `(!)` 要判断（分岐/優先度/仕様決め）
---

## 現状（このスレッドで確実に確認できたこと）
- [x] Bot は正常稼働（polling / 応答あり）
- [x] `determine_action_count()`（2/3/4箇条書き抽選）が希望通りの分布
- [x] Git はクリーン（作業内容はコミット済みの状態）
- [ ] [~] docs に **WBS.md / IIWBS.md** が混在（MVP短縮版と拡張版が並立している可能性）

> 注意：以下の「完了チェック」は、**この会話で確実に裏取りできた範囲**だけ [x] にしています。  
> 実装済みか不明なところは [~] / [ ] / (!) にしてあります（必要ならあとで現物確認して更新）。

---

## フェーズ0: 土台（リポジトリ・設定・品質の最低ライン）
- [x] T0-01: リポジトリ初期化（Git）
- [x] T0-02: ディレクトリ構成（bot/, api/, core/, db/, docs/, tests/）
- [x] T0-03: venv / requirements（起動できる状態）
- [x] T0-04: `.env.example` と設定読み込みの雛形（最低限）
- [x] T0-05: 基本ドキュメント（README / docs の追加）
- [ ] [~] T0-06: ローカル起動手順の固定（`run_bot.ps1` などが “迷わず再現” できる）

---

## フェーズ1: Bot 最小UX（/start・メニュー・コマンド導線）
- [x] T1-01: `/start`（挨拶＋使い方）
- [x] T1-02: メニュー（占い / 相談 / チャージ / ステータス 等の導線）
- [x] T1-03: `help`/`terms`/`support` の内容整備（文面・URL・窓口）
- [x] T1-04: 入力ガード（空入力・長文・絵文字だらけ等でも崩れない）
- [ ] [~] T1-05: 例文（質問の例）をテーマ別に最小セット
- [x] T1-06: 多重送信対策（連打・同時リクエストのキュー/ロック）
- [x] T1-07: “戻る/やり直し”導線（テーマ選択に戻る、質問を変える等）
- [ ] T1-08: 管理者用コマンド（/admin status / /admin grant 等）※必要なら

---

## フェーズ2: タロット基盤（カード・スプレッド・抽選・表示）
- [ ] [~] T2-01: 78枚＋正逆のカード定義（ID/名称/キーワード）
- [ ] [~] T2-02: スプレッド定義（1枚/3枚）＋将来拡張枠
- [x] T2-03: 抽選ロジック（箇条書き数 action_count の抽選）※今回確定
- [ ] [~] T2-04: “引いたカード”の表示フォーマット固定（見出し/改行/箇条書き）
- [ ] T2-05: スプレッドごとの役割語彙（過去/現在/未来、原因/対策 等）テンプレ
- [ ] T2-06: 単体テスト（最低：カード整合性・抽選分布・フォーマット）
- [ ] T2-07: 禁止/注意テーマの扱い（医療/法律/投資助言などの免責・誘導）(!)

---

## フェーズ3: 会話フロー（状態管理・分岐・再入）
- [ ] [~] T3-01: テーマ選択（InlineKeyboard）※画面上は動作している
- [ ] [~] T3-02: 質問入力（フリーテキスト）※動作
- [ ] [~] T3-03: スプレッド選択（1枚/3枚 等）※動作
- [x] T3-04: 会話状態（theme/question/spread）を安全に保持（メモリ or 永続）
- [ ] T3-05: “途中で別コマンド”が来たときの状態リセットルール
- [ ] T3-06: タイムアウト（一定時間で状態破棄）
- [ ] T3-07: 相談モード（雑談/短文回答）の仕様確定（回数制限と文体）(!)
- [ ] T3-08: 同一ユーザーの並行セッションをどう扱うか（上書き/並列）(!)

---

## フェーズ4: LLM 連携（プロンプト・安全・コスト）
- [x] T4-01: OpenAI へのAPI呼び出し（ログ上で 200 OK 確認）
- [ ] [~] T4-02: タロット用プロンプトテンプレ（安定した型）
- [x] T4-03: “箇条書き数”のガイダンスをLLM出力に反映（action_count）
- [ ] T4-04: テーマ別プロンプト分岐（恋愛/仕事/人生…）
- [ ] T4-05: NG/危険領域の制御（医療/法律/自傷他害 等）(!)
- [ ] T4-06: レスポンス後処理（長文カット/要点先出し/改行整形）
- [ ] T4-07: 料金最適化（モデル選定、max_tokens、キャッシュ、リトライ）
- [ ] (!) T4-08: API分離の要否（Bot直呼び vs FastAPI経由）※MVPは直呼びでもOK

---

## フェーズ5: 課金・制限（収益化の中核）
- [ ] [~] T5-01: 無料枠（trial）回数・リセット仕様（1日2回など）
- [ ] [~] T5-02: /status（残回数・次回リセット・期限表示）
- [ ] [~] T5-03: /buy（チャージ導線）文面とUI
- [ ] (!) T5-04: 決済方式の確定（Telegram Stars / Stripe / Bot Payments の優先順位）
- [ ] T5-05: 決済完了→権限付与（entitlements）実装
- [ ] T5-06: 返金/失敗/二重決済の扱い（状態遷移表）
- [ ] T5-07: 管理者で手動付与/剥奪（トラブル対応）
- [ ] T5-08: 価格表（商品ID・内容・回数・有効期限）を設定ファイル化
- [ ] T5-09: 不正対策（複垢/同端末/再インストール）※やりすぎ注意
- [ ] T5-10: コスト監視（ユーザー別トークン/日次上限）(!)

---

## フェーズ6: DB・永続化（最低限の観測と再現性）
> MVPは「なくても動く」けど、**改善サイクル**を回すには早めに必要。

- [ ] T6-01: SQLite（β）で DB 初期化（schema.sql or ORM）
- [ ] T6-02: users（ユーザー基本情報）
- [ ] T6-03: sessions（会話セッション）
- [ ] T6-04: messages（入出力ログ：要点だけ）
- [ ] T6-05: tarot_draws（引いたカード・正逆・スプレッド）
- [ ] T6-06: entitlements（購入/残回数/期限）
- [ ] T6-07: app_events（イベント計測：start/reading_done/buy_click…）
- [ ] T6-08: audits（重要操作ログ：付与/剥奪など）
- [ ] T6-09: DB マイグレーション方針（簡易でOK：1ファイルでも可）

---

## フェーズ7: 信頼性（落ちない・迷子にしない）
- [ ] [~] T7-01: ログ整備（request単位で追える）
- [ ] T7-02: 例外ハンドリング（OpenAI失敗/タイムアウト/429）
- [ ] T7-03: リトライ方針（指数バックオフ、最大回数）
- [ ] T7-04: 監視（ヘルスチェック/死活監視/通知）
- [ ] T7-05: レート制限（ユーザー別：秒間/分間）
- [ ] T7-06: シークレット管理（.env漏洩防止、ログに鍵を出さない）

---

## フェーズ8: “フロント”＝ユーザー体験（Telegram内UX + 外部LP）
### 8-A Telegram内UX（最重要）
- [ ] T8A-01: 最初の60秒UX（迷わせない：3タップで占い完了）
- [ ] T8A-02: 結果の見せ方（結論→理由→行動、読みやすさ最優先）
- [ ] T8A-03: 続き導線（深掘り質問/3枚提案/次回予告）
- [ ] T8A-04: 相談モードの価値定義（短文・共感・行動提案）
- [ ] T8A-05: “購入”の心理導線（無料→体験→不足→解決）
- [ ] T8A-06: メッセージ文体の統一（丁寧でやさしい敬語）※ユーザー向け

### 8-B 外部LP（任意：やるなら最小）
- [ ] (!) T8B-01: LP を作るか（作るなら1ページでOK）
- [ ] T8B-02: LP 必須：価値/使い方/料金/免責/リンク（Botへ）
- [ ] T8B-03: 計測（UTM/クリック/開始率）

---

## フェーズ9: キャラクター設計（人格＝ブランド）
- [ ] T9-01: キャラ設定シート（口調・価値観・NG・得意領域）
- [ ] T9-02: キャラの“約束”（ユーザーに与える安心・安全）
- [ ] T9-03: テーマ別キャラの振る舞い（恋愛＝寄り添い、仕事＝整理…）
- [ ] T9-04: 例文ライブラリ（開始/深掘り/断り/購入誘導/お礼）
- [ ] T9-05: 画像アセット方針（アイコン/ヘッダー/OGP）
- [ ] T9-06: 文章スタイルガイド（短文/中文/長文の型）

---

## フェーズ10: マーケ・グロース（“計測できる施策だけ”やる）
- [ ] T10-01: 価値提案を1文で固定（誰の何をどう解決するか）
- [ ] T10-02: 流入チャネル設計（X/Instagram/Telegram/Note 等の役割分担）
- [ ] T10-03: 投稿テンプレ（週7本作れる型：悩み→解決→導線）
- [ ] T10-04: 招待/紹介導線（紹介コード・特典）※後でOK
- [ ] T10-05: KPI設計（開始率/完了率/課金率/継続率/粗利）
- [ ] T10-06: A/B（文面/価格/無料枠）を“最小”で回す
- [ ] T10-07: クリエイティブ生成フロー（画像/短文/動画の作り方を固定）
- [ ] T10-08: 炎上・規約リスク回避（NG表現チェック）(!)

---

## フェーズ11: リリース準備（β→公開）
- [ ] [~] T11-01: launch_checklist.md の更新・運用
- [ ] T11-02: 利用規約/免責/プライバシー（最小）
- [ ] T11-03: 本番環境のデプロイ先決定（VPS/クラウド）
- [ ] T11-04: バックアップ（DB/ログ）
- [ ] T11-05: “壊れたときの復旧手順”を1枚にまとめる

---

## フェーズ12: 改善サイクル（運用の型）
- [ ] T12-01: 週次レビュー（KPI→仮説→修正→検証）
- [ ] T12-02: 失敗ログの型（失敗理由カテゴリを決める）
- [ ] T12-03: コスト監視（月次：原価率・上限アラート）
- [ ] T12-04: 施策バックログ（次の一手を常に3つ持つ）
