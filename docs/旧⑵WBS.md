# WBS - Telegram Tarot Bot（MVP→β→初期グロース）

> 目的：**「占い体験が気持ちよく、分かりやすく、また使いたくなる」**を最優先に、  
> **バックエンド仕上げ + “フロント(=ユーザー体験)” + キャラクター + マーケ**までを一本のWBSに落とし込む。

---

## 0. 前提

### 0-1. MVPで必ず満たす価値
- 迷わず使える（導線が短い）
- 出力が読みやすい（長すぎない／要点が見える）
- 期待が一致している（無料枠・課金・できること/できないことが明確）
- 安定して動く（落ちない／遅すぎない／課金周りが壊れない）

### 0-2. “フロント”の定義（ここでは Telegram UX）
- `/start` からのオンボーディング
- テーマ選択・質問入力・スプレッド選択・結果表示
- 返信の構造（見出し/段落/箇条書き/締め）
- ボタン（ReplyKeyboard / InlineKeyboard）と案内文言
- 課金導線（制限→提案→購入→復帰）
- サポート/規約/免責/ステータス確認

### 0-3. Doneの定義（タスク完了基準）
- 仕様（入力/出力/例外）が文章で残っている
- テスト or 検証手順（PowerShell/pytest）がある
- ログで追える（失敗時の原因が分かる）
- 既存機能を壊さない（回帰の確認がある）

---

## 1. 開発WBS（MVP向け）
> 各タスクは **「実装 → テスト/検証 → ドキュメント更新」** をセットで完了にする。

---

## フェーズ0: プロジェクト骨組み（Foundation）
- T0-01: リポジトリ初期化（Git）
- T0-02: ディレクトリ構成作成（bot/, api/, core/, db/, docs/, tests/）
- T0-03: Python仮想環境・requirements.txt / pyproject.toml 作成
- T0-04: `.env.example` と設定読み込みの雛形（core/config 等）
- T0-05: `AGENTS.md` / `README.md` / ドキュメント追加
- T0-06: 依存関係の固定（pip-compile 等は任意）＋更新手順をREADMEへ
- T0-07: コーディング規約（ruff/black/mypy のどれを使うか）を決める
- T0-08: CI（GitHub Actions）で `python -m compileall` / `pytest` を回す

---

## フェーズ1: 最小動作（/start → 挨拶 & health）
- T1-01: aiogram による Bot 起動（/start ハンドラ）
- T1-02: API（FastAPI）雛形（使うなら health endpoint）
- T1-03: ログ設定（ログレベル、ファイル/STDOUT、フォーマット）
- T1-04: 起動スクリプト（Windows/PowerShell 含む）整備（run_bot.ps1 など）
- T1-05: ローカルで Bot が起動し、基本動作を確認
- T1-06: 本番運用の起動方法（pm2 / systemd / Windowsタスク）を決め、手順を docs/ に残す

---

## フェーズ2: タロットカード・スプレッドロジック（Domain）
- T2-01: 78枚＋正逆のカード定義（ID/名称/正逆/キーワード/短い説明）
- T2-02: スプレッド定義（1枚/3枚 ほか）
- T2-03: 抽選ロジックの仕様化（乱数seed方針、再現性の扱い）
- T2-04: 単体テスト（カード/スプレッド/抽選）
- T2-05: “表示用フォーマット”標準化（カード名・正逆・要点表示の形式）
- T2-06: 将来拡張（追加スプレッド/画像生成等）を見越した拡張ポイントを docs に明記

---

## フェーズ3: 会話フロー & UX設計（Telegram Front）
- T3-01: テーマ選択（InlineKeyboard）設計（恋愛/仕事/人生 など）
- T3-02: 質問入力ステップ（フリーテキスト）＋入力例の提示
- T3-03: スプレッド選択（1枚/3枚）＋違いの説明（迷わせない）
- T3-04: 状態管理（テーマ/質問/スプレッド/カード/回数）を整備（メモリ→DBに置換しやすく）
- T3-05: 返信テンプレ（見出し→要約→カード→解釈→行動提案）を固定化
- T3-06: 文字量ガード（長すぎる時の短縮、箇条書き数の上限、改行ルール）
- T3-07: “次の一手”導線（追加質問例、別テーマ提案、/read3 提案など）
- T3-08: エラーメッセージ設計（ユーザーの不安を増やさない言い回し）
- T3-09: UI一貫性（絵文字/句読点/敬語/呼称/締め）をスタイルガイド化（docs/）

---

## フェーズ4: LLM連携（Backendの心臓部）
- T4-01: LLM呼び出しモジュール（タイムアウト、リトライ、例外分類）
- T4-02: プロンプトテンプレ管理（ファイル分割・バージョン付け）
- T4-03: 出力整形（構造化→文章化）：必ず“読みやすい”形に落とす
- T4-04: コスト制御（最大トークン、短縮モード、頻繁な呼び出し抑制）
- T4-05: 安全策（過度な断定回避、医療/法律の注意書き、センシティブ回避）
- T4-06: 回帰テスト用 “固定入力→期待フォーマット” を tests/ に用意
- T4-07: 重要ログ（応答時間、モデル、トークン概算、失敗理由）を記録

---

## フェーズ5: DB設計・永続化（SQLite→将来拡張）
- T5-01: スキーマ確定（users/sessions/messages/tarot_draws）
- T5-02: 課金・権限（entitlements）を追加しても破綻しない設計にする
- T5-03: Bot側でユーザー/セッションを保存
- T5-04: LLM入出力は最小限で保存（全文は避け、要約/メタ中心）
- T5-05: 簡易クエリ（最新セッション、回数残、直近の傾向 等）
- T5-06: 移行方針（SQLite→Postgres 等）を docs に置く（今は設計だけでもOK）

---

## フェーズ6: ログ・イベント・監査（運用の目）
- T6-01: app_events（イベント名/時刻/プロパティJSON）
- T6-02: 主要イベント定義（start/テーマ選択/質問送信/結果表示/制限到達/購入 など）
- T6-03: audits（管理者操作、設定変更、重要アクション）
- T6-04: 障害時に見るログ/手順を docs にチェックリスト化
- T6-05: 監視の最低ライン（遅延、失敗率、課金失敗）を決める
- T6-06: 個人情報を極力持たない設計の確認（保持期間/削除導線）

---

## フェーズ7: 収益化（課金導線・権利管理）
- T7-01: 料金プラン確定（無料枠・都度課金・サブスク）
- T7-02: 購入UX（/buy）設計：迷わない文言、価格、増える価値を明確に
- T7-03: Telegram Stars / Bot Payments / Stripe の採用方針決定（併用時は優先順位）
- T7-04: 決済後 entitlements 反映（即時反映・失敗時の復旧）
- T7-05: /status（期限/残回数/次回リセット）表示を分かりやすく
- T7-06: “過剰な煽り”にならない課金導線（信頼を守る）
- T7-07: 返金・問い合わせ導線（/support）整備

---

## フェーズ8: β運用準備（品質・安定化）
- T8-01: 日本語UIの文言磨き（短く・優しく・誤解がない）
- T8-02: 例題（質問テンプレ）を複数用意し初心者でも試せる状態に
- T8-03: レート制限（連打/荒らし対策）＋失敗時の案内
- T8-04: タイムアウト時の再試行導線（丁寧さ）
- T8-05: 既知の制限事項（できないこと）を /terms に明記
- T8-06: スモールβ（10〜30人）でログを見ながら改善サイクル

---

## フェーズ9: “フロント”強化（体験を商品にする）
- T9-01: 返信フォーマット最終固定（テンプレ2〜3種：通常/短文/深掘り）
- T9-02: テーマ別“語り口”最適化（恋愛=共感、仕事=整理、人生=俯瞰）
- T9-03: 継続導線（前回の続き提案、振り返り、次の質問例）
- T9-04: 無料枠の終わり方（気持ちよく終わる締め）
- T9-05: 長文質問の圧縮（要点の再提示→回答）
- T9-06: NG表現リスト（断定/煽り/不安商法）を作る
- T9-07: 視認性ルール（改行、箇条書き、見出し）徹底

---

## フェーズ10: キャラクター設計（人格＝ブランド）
- T10-01: キャラ設定シート（口調/価値観/得意/NG）
- T10-02: キャラの「約束」：ユーザー体験（安心・背中押し・整理・共感）
- T10-03: システムプロンプト規約（安全・免責・過度な断定回避）
- T10-04: テーマ別サブキャラ案（必要なら）
- T10-05: 例文ライブラリ（開始/締め/励まし/注意/課金案内）を docs に集約
- T10-06: 画像アセット（アイコン/ヘッダー/簡易ロゴ）制作とガイドライン化

---

## フェーズ11: マーケ・グロース（計測できる導線だけ作る）
- T11-01: 価値提案（誰の何を解決するか）を1文で固定
- T11-02: チャネル選定（X/Instagram/Telegramチャンネル/Note 等）＋運用方針
- T11-03: LP（最低1ページ）：機能/料金/FAQ/免責/導線（深いリンク）
- T11-04: 計測設計（start数、完了数、課金率、継続率）
- T11-05: 投稿テンプレ/週次テーマ/成功パターンのメモ（施策WBS）
- T11-06: 招待導線（紹介文、コピペ用短文、画像1枚）
- T11-07: A/B（文言/価格/無料枠）を“小さく”回す手順を決める

---

## フェーズ12: リリース & 改善サイクル
- T12-01: リリースチェックリスト更新（launch_checklist.md）
- T12-02: 障害一次対応手順（止める/再起動/ログ/復旧）を docs 化
- T12-03: 週次レビュー（KPI→仮説→改善→反映）テンプレ化
- T12-04: バックログ運用（P1/P2/P3）と捨てる判断基準を決める
- T12-05: 大型機能の前に“UX負債返済”期間を必ず作る

---

## 付録: 進捗の付け方（おすすめ）
- 各タスクに `- [ ]` / `- [x]` を付けてGitHub上で管理
- PR/コミットIDをタスクの末尾に貼る（追跡のため）
