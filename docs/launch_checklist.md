# Launch checklist (T-48h → T+48h)

目的: 48 時間で迷わず回せる最低限のローンチ手順。デザインや文章生成ロジックは変更しない前提。コード改変は行わず、運用確認に集中する。

## すでに仕込まれている仕組み（確認のみ / 変更不要）
- ログは `core.logging.SafeLogFilter` 経由でリクエスト ID（`rid=`）付き・シークレットマスク済みで `logs/bot.log` にも出力される。出力先やマスク設定は変えないまま、起動時にログが生成されることだけ確認する。
- レート制限のしきい値は環境変数 `THROTTLE_MESSAGE_INTERVAL_SEC`（初期値 1.2s）と `THROTTLE_CALLBACK_INTERVAL_SEC`（0.8s）で調整済み。負荷が問題なければ既定値のまま。
- 課金切り替えは `PAYWALL_ENABLED` でトグル。管理者 ID は `ADMIN_USER_IDS`（カンマ区切り）で設定し、管理者は常に課金フリー扱い。
- 管理者オペレーション: `/admin grant|revoke <user_id> <SKU>` で付与/剥奪、`/refund <charge_id>` で Stars 返金。どれも管理者のみ実行可能。

## 今回はやらないこと（後半フェーズに回す）
- 大規模監視・ダッシュボード構築（ログと簡易カウンタ確認で代用）。
- 会話トーンやキャラクター人格の作り込み（既存文面のまま）。
- LLM/課金ロジックの仕様変更や追加プロダクト設計。

## T-48h 〜 T-24h：事前準備と安全網
- [ ] PowerShell で `tools/sync.ps1` を実行し、`pytest -q` が緑で通るログを保存。
- [ ] `.env`（本番用）の固定: `TELEGRAM_BOT_TOKEN` / `OPENAI_API_KEY` / `SUPPORT_EMAIL` / `ADMIN_USER_IDS` / `PAYWALL_ENABLED` を埋め、必要なら `THROTTLE_MESSAGE_INTERVAL_SEC` / `THROTTLE_CALLBACK_INTERVAL_SEC` / `SQLITE_DB_PATH` も調整。
- [ ] 管理者用の動作確認（ステージング推奨）: `/admin grant` → `/status` に反映、`/admin revoke` で戻せる、誤操作しないよう対象 ID をダブルチェックする運用を決める。
- [ ] ログ出力の健全性確認: 起動直後に `logs/bot.log` が作成され、`rid=` が付いておりシークレットがマスクされていることを目視。
- [ ] バックアップ: `docs/sqlite_backup.md` を見ながら最新 DB をバックアップ（ダンプ/コピーどちらかで良い）し、リストア手順を一度なぞっておく。
- [ ] 支払いトグルの方針決定: ローンチ時点で `PAYWALL_ENABLED` を ON/OFF のどちらにするかを合意し、切り替えタイミングをメモ。
- [ ] 通信・Bot 再起動手順を共有（再起動後に `.env` が読まれることを確認）。

## T-24h 〜 T-6h：本番反映と導線確認
- [ ] 本番 `.env` をサーバーへ配置し、Bot を再起動。`/status` とログで起動完了を確認。
- [ ] 決済スモーク: `/buy` → 購入 → `/status` に反映。ボタン連打時に「購入画面は既に表示しています」と出て二重発行しない。
- [ ] stale callback（有効期限切れボタン）で STALE_CALLBACK_MESSAGE が返り、プロセスが落ちない。
- [ ] pre_checkout で `user_id` / `sku` 不一致があれば拒否され、成功時は `/status` に反映される。
- [ ] `/start` `/buy` `/status` の文面で無料枠・課金導線・最初の一手が 1 画面で伝わる。
- [ ] `/paysupport` の案内テンプレで必要情報（決済 ID など）が提示される。
- [ ] レート制限が効いているか軽く手動確認（メッセージ/ボタンの連打でエラーにならないが遅延する）。

## T-6h 〜 T-0h：公開直前の最終チェック
- [ ] ワンオラクル無料枠（1 日 2 回）はショート回答で、3 回目以降は課金導線が出る。
- [ ] 雑談/相談は初回 5 日間・1 日 2 通までで、6 日目以降はパスなしだとブロックされる。
- [ ] Stars 価格がカタログ通り（350/500/1000/1500/…）に表示・決済される。
- [ ] `/status` にパス期限・無料枠残数・チケット残数が表示される。
- [ ] 決済完了後の案内から「占いに戻る」ボタンで導線復帰できる。
- [ ] ログに日次カウントや購入エラーが出ていないことを再確認（`rid=` でユーザー問い合わせに紐付けられる）。
- [ ] ロールバック手順を即実行できる状態にする（例: `PAYWALL_ENABLED=false` で課金導線を閉じる、バックアップ DB に戻す）。

## T+0h 〜 T+48h：初期運用
- [ ] 障害時の初動: 支払いを止める場合は `PAYWALL_ENABLED=false` にして再起動し、`/paysupport` / `/help` で案内文を出す。
- [ ] 管理者オペの再確認: `/admin grant|revoke` での付与/剥奪、`/refund` での返金が即時反映されることを実際に試す（少額テスト）。
- [ ] KPI/離脱点の軽チェック: `/start` → `/buy` の遷移率、無料枠消化率をログや簡易カウントで見る。
- [ ] フィードバック収集: サポートメール/DM の問い合わせ件数を記録し、次リリースの修正候補を箇条書きで残す。
- [ ] 48h 時点でバックアップを再取得し、負荷やレート制限設定を見直す。
